{
  "ProjectId": 8,
  "ProjectName": "Integration Test",
  "JobName": "99. Summarise Test Results",
  "Logging": 0,
  "LogBatchSize": 5,
  "CancelJobFlag": false,
  "LoggingType": null,
  "Tasks": [
    {
      "JobName": "99. Summarise Test Results",
      "TaskContent": "INSERT INTO dbo.ExecutionLogArchive (ArchiveDatetime, ExecutionDatetime, TargetConnection, TestCaseID, TestResult, ErrorDescription)\r\n    SELECT CAST(SWITCHOFFSET(GETDATE(), DATEPART(TZOFFSET, GETDATE() AT TIME ZONE 'AUS Eastern Standard Time')) AS datetime), ExecutionDatetime, TargetConnection, TestCaseID, TestResult, ErrorDescription FROM dbo.ExecutionLog",
      "TaskName": "Archive Latest Execution Log",
      "ProjectId": 8,
      "ProjectName": null,
      "TaskTypeName": "SQL Statement",
      "Logging": 1,
      "LastEndPoint": null,
      "PendingEndPoint": null,
      "ParameterNames": "",
      "ParameterDefaults": "",
      "SourceSchema": null,
      "TargetSchema": null,
      "SourceConnectionName": "Regression Test Logging",
      "TargetConnectionName": null,
      "SourceFileName": null,
      "TargetFileName": null,
      "SourceClusterName": null,
      "TargetClusterName": null,
      "SourceFileId": null,
      "TargetFileId": null,
      "MaxThreads": 4,
      "ParallelDm": true,
      "PythonEnvironmentName": null,
      "RunWithAgentId": 2,
      "Agent": {
        "AgentId": 2,
        "AgentName": "PerPrd-WEB01.bizdata.local",
        "HostName": "PerPrd-WEB01.bizdata.local",
        "DateCreated": "0001-01-01T00:00:00",
        "DateUpdated": "0001-01-01T00:00:00",
        "HeartBeat": "0001-01-01T00:00:00",
        "Version": null,
        "TaskQueues": null,
        "ConnectionId": null,
        "IsHealthy": false
      },
      "PythonEnvironment": null,
      "SourceConnection": null,
      "TargetConnection": null,
      "SourceCluster": null,
      "TargetCluster": null,
      "LoggingType": null,
      "TaskType": null,
      "TaskTable": [],
      "TaskConnections": []
    },
    {
      "JobName": "99. Summarise Test Results",
      "TaskContent": "# Define Monitor test environment hosts\r\n$TST = @{\r\n    \"idsHostname\" = \"test-id.loomesoftware.com\";\r\n    \"apiHostname\" = \"test-monitor-api.loomesoftware.com\";\r\n};\r\n\r\n###################################################################\r\n# Change this to your selected host respectively.\r\n$selectedHost = $TST;\r\n\r\n# Enter your client ID here.\r\n$clientId = \"10eb3b6b-ba92-4279-af68-8ff22a109eac\";\r\n\r\n# Provide the name of the Project and the Rule that to be executed\r\n$projectName = \"Loome Team\";\r\n$ruleName = \"Integrate Test Result\";\r\n\r\n# Define time frequency for checking rule execution status\r\n$PollSeconds = 20;\r\n###################################################################\r\n\r\n# Obtain access to target tenant\r\n$tokenBody = @{\r\n    \"grant_type\"    = \"client_credentials\";\r\n    \"client_id\"     = $clientId;\r\n    \"client_secret\" = $clientId;\r\n    \"scope\"         = \"webApi\"\r\n};\r\n\r\n$baseUrl = \"https://$($selectedHost['apiHostname'])/api/v1/\";\r\n\r\n$accessToken = ((Invoke-WebRequest -Uri \"https://$($selectedHost['idsHostname'])/connect/token\" -Method Post -Body $tokenBody).Content | ConvertFrom-Json).access_token;\r\n$accessHeaders = @{\"Authorization\" = \"bearer $accessToken\" }\r\n\r\n# Obtain Id of the Monitor testing project\r\n$projectReq = (Invoke-WebRequest -Uri \"$($baseUrl)Projects?pagenumber=1&pageSize=1000\" -Headers $accessHeaders);\r\n$projects = $projectReq.Content | ConvertFrom-Json;\r\nforeach ($project in $projects) {\r\n    if ($project.projectName -eq $projectName) {\r\n        $projectId = $project.projectId;\r\n        break;\r\n    }\r\n}\r\n\r\n# Obtain Id of the rule that will be executed\r\n$rulesReq = (Invoke-WebRequest -Uri \"$($baseUrl)rulesets/paged?pageNumber=1&pageSize=200&projectId=$($projectId)\" -Headers $accessHeaders);\r\n$rules = ($rulesReq.Content | ConvertFrom-Json).results;\r\nforeach ($rule in $rules) {\r\n    if ($rule.rulesetName -eq $ruleName) {\r\n        $ruleId = $rule.rulesetId;\r\n        break;\r\n    }\r\n}\r\n\r\n$ruleExecReq = Invoke-WebRequest -Method Post -Uri \"$($baseUrl)rulesets/$ruleId/execute\" -Headers $accessHeaders -ContentType \"application/json\"\r\n$ruleExec = $ruleExecReq.Content | ConvertFrom-Json;\r\n    \r\ndo {\r\n    $execStatReq = Invoke-WebRequest -Method Get -Uri \"$($baseUrl)rulesets/executions/$($ruleExec.ruleExecutionId)\" -Headers $accessHeaders -ContentType \"application/json\";\r\n    $execStat = $execStatReq.Content | ConvertFrom-Json;\r\n\r\n    if (!(\"Success\", \"Failure\", \"Cancelled\").contains($execStat.status)) {\r\n        Write-Output \"Rule Execution $($ruleExec.ruleExecutionId) is '$($ruleExec.Status)', waiting $PollSeconds seconds before checking status again...\";\r\n        Start-Sleep -Seconds $PollSeconds;\r\n    }\r\n} while (!(\"Success\", \"Failure\", \"Cancelled\").contains($execStat.status))\r\n\r\nif ($execStat.status -ne \"Success\") {\r\n    throw \"Alert execution $($ruleExec.ruleExecutionId) failed with status '$($execStat.Status)' (Reason: $($execStat.Message))\"\r\n} else {\r\n    Write-Output \"Rule execution completed successfully!\"\r\n}",
      "TaskName": "Review Integrate Test Result",
      "ProjectId": 8,
      "ProjectName": null,
      "TaskTypeName": "PowerShell Core",
      "Logging": 1,
      "LastEndPoint": null,
      "PendingEndPoint": null,
      "ParameterNames": "",
      "ParameterDefaults": "",
      "SourceSchema": null,
      "TargetSchema": null,
      "SourceConnectionName": null,
      "TargetConnectionName": null,
      "SourceFileName": null,
      "TargetFileName": null,
      "SourceClusterName": null,
      "TargetClusterName": null,
      "SourceFileId": null,
      "TargetFileId": null,
      "MaxThreads": 4,
      "ParallelDm": true,
      "PythonEnvironmentName": null,
      "RunWithAgentId": 2,
      "Agent": {
        "AgentId": 2,
        "AgentName": "PerPrd-WEB01.bizdata.local",
        "HostName": "PerPrd-WEB01.bizdata.local",
        "DateCreated": "0001-01-01T00:00:00",
        "DateUpdated": "0001-01-01T00:00:00",
        "HeartBeat": "0001-01-01T00:00:00",
        "Version": null,
        "TaskQueues": null,
        "ConnectionId": null,
        "IsHealthy": false
      },
      "PythonEnvironment": null,
      "SourceConnection": null,
      "TargetConnection": null,
      "SourceCluster": null,
      "TargetCluster": null,
      "LoggingType": null,
      "TaskType": null,
      "TaskTable": [],
      "TaskConnections": []
    }
  ],
  "JobSequences": [
    {
      "JobName": "99. Summarise Test Results",
      "RunSequence": 1,
      "ParallelSequence": 0,
      "ParameterValues": null,
      "ConnectionId": null,
      "Active": true,
      "TaskName": "Archive Latest Execution Log",
      "Connection": null
    },
    {
      "JobName": "99. Summarise Test Results",
      "RunSequence": 2,
      "ParallelSequence": 0,
      "ParameterValues": null,
      "ConnectionId": null,
      "Active": true,
      "TaskName": "Review Integrate Test Result",
      "Connection": null
    }
  ],
  "JobSequenceDependencies": [],
  "JobDependencies": []
}